# Web性能权威指南

## TCP的构成
因特网有两个核心协议：TCP和IP。IP即Internet Protocol，负责联网主机之间的路由选择和寻址；TCP即Transmission Control Protocol，负责在不可靠的传输信道上提供可靠的抽象层。

* 三次握手
* 拥塞预防及控制
* 带宽延迟积
* 队首阻塞

### 三次握手
所有的TCP连接一开始都要经过三次握手，因此每次传输前都必须经历一次完整的往返。

* SYN：客户端选择一个随机序列号x，并发送一个SYN分组，其中还包括一些其他的TCP标志和选项。
* SYN ACK：服务端给x加1，并选择自己的一个随机序列号y，追加自己的标志和选项，然后返回响应。
* ACK：客户端给x和y加1并发送握手期间的最后一个ACK分组。

> TCP Fast Open：由于非常短的TCP连接在互联网上随处可见，握手阶段已经成为影响网络总延迟的一个重要因素。为解决这个问题，人们积极寻找各种方案，TCP快速打开就是这样一种机制。

### 拥塞预防及控制
* 流量控制，一种预防发送端过多向接收端发送数据的机制。

为了流量控制，TCP连接的每一方都要通告自己的接受窗口rwnd，这个过程贯穿每个TCP连接的整个生命周期：每个ACK分组都会携带相应的最新rwnd指，以便两端动态调整数据流速，使之适应发送端和接收端的容量及处理能力。

* 慢启动，服务器通过算法来确定每个连接的窗口大小。

首先，服务器通过TCP初始化一个新的拥塞窗口变量cwnd，将其设置为一个系统设定的保守值。服务端和客户端之间最大可以传输的数据量取rwnd和cwnd之间的最小值。此后，每收到一个ACK，慢启动算法就告诉服务器可以将它的cwnd窗口增加1倍的TCP段。即每次收到ACK后，都可以多发送两个新的分组。这个阶段通常称为“指数增长”阶段。

* 预防拥塞

TCP调节网络性能主要依赖丢包反馈机制，当窗口大小超过系统配置的拥塞阈值ssthresh时，或有分组丢失为止，此时拥塞预防算法介入。

> TCP比例降速，最初TCP使用AIMD（倍减加增）算法，即丢包时，先将拥塞窗口减半，然后每次往返再缓慢给窗口添加一个固定值，但是这种算法过于保守，因此有了后面的PRR（比例降速）算法。

### 带宽延迟积
BDP（Bandwidth-delay product），带宽延迟积。数据链路的容量与其端到端延迟的乘积。

*计算公式*：**数据传输速率=窗口大小/往返时间**

### 队首阻塞

TCP在不可靠的信道上实现可靠的网络传输，为了实现按序交付，每个TCP分组都会带着一个唯一的序列号被发出，如果中途有一个分组没能到达，那么后续分组必须保存在TCP缓冲区，等到丢失的分组重新发送到达接收端。在此之前，应用程序只能通过套接字读数据时感觉到延迟交付，这种效应被称为**队首阻塞**。


## UDP的构成

> 数据报（datagram），一个完整、独立的数据实体，携带着从源节点到目的节点的足够信息，对这些节点间之前的数据交换和传输网络没有任何依赖。

## 传输层安全（TLS)

* TLS握手：在TCP握手前提下，客户端通过服务端的公钥加密后发送回服务端，服务端用私钥解密客户端生成的Premaster secret，此后双方使用Premaster secret对称加密来进行会话。
* TLS会话恢复：通过sessionID或session ticket来快速恢复会话，采用之前使用的对称密钥。
* 信任链与证书颁发机构：浏览器内置根证书的名单，对服务器携带的证书进行链式信任，由此来判断证书是否可信任。
* 信任链与证书颁发机构：浏览器内置根证书的名单，对服务器携带的证书进行链式信任，由此来判断证书是否可信任。
